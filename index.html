<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat with Image Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a, #0f2f3d);
            color: #00f7ff;
            font-family: 'Inter', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #00f7ff #1a1a1a;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #00f7ff;
            border-radius: 4px;
        }
        .glow {
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.5);
        }
        .message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .header {
            background: rgba(0, 247, 255, 0.1);
            border-bottom: 1px solid #00f7ff;
        }
        .input-container {
            background: rgba(26, 26, 26, 0.9);
            border-top: 1px solid #00f7ff;
        }
        .markdown-content {
            line-height: 1.6;
            margin-top: 0.5rem;
        }
        .markdown-content p {
            margin-bottom: 0.5rem;
        }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content li {
            margin-bottom: 0.25rem;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
            font-weight: bold;
        }
        .markdown-content h1 {
            font-size: 1.5rem;
        }
        .markdown-content h2 {
            font-size: 1.25rem;
        }
        .markdown-content h3 {
            font-size: 1rem;
        }
        .image-preview {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header p-4">
        <h1 class="text-2xl font-bold text-cyan-400 text-center">Chat AI</h1>
    </div>

    <!-- Chat Container -->
    <div class="chat-container p-4">
        <div id="chatBox" class="space-y-4 max-w-4xl mx-auto"></div>
    </div>

    <!-- Input and Send Button -->
    <div class="input-container p-4">
        <div class="max-w-4xl mx-auto flex flex-col gap-2">
            <div class="flex gap-2">
                <input type="text" id="userInput" class="flex-1 p-3 bg-gray-800 border border-cyan-500 rounded focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white" placeholder="Ketik pesan atau soal..." autofocus>
                <button id="sendButton" class="px-4 py-2 bg-cyan-500 text-gray-900 rounded hover:bg-cyan-400 transition glow">Kirim</button>
            </div>
            <div class="flex items-center gap-2">
                <input type="file" id="imageInput" accept="image/*" class="text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-cyan-500 file:text-gray-900 file:hover:bg-cyan-400">
                <span class="text-sm text-cyan-300">Unggah gambar untuk analisis</span>
            </div>
        </div>
    </div>

    <script>
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const imageInput = document.getElementById('imageInput');
        const chatBox = document.getElementById('chatBox');
        const apiKey = 'AIzaSyDKlf8gKxGNR3r7E4ShvozuWocWFdXCiLQ'; // Ganti dengan API key Gemini Anda

        // System prompt untuk mengatur perilaku AI
        const systemPrompt = `Anda adalah asisten Xyraa AI yang ramah dan profesional. Berikan jawaban yang jelas, ringkas, dan informatif dalam bahasa Indonesia. Jika diberikan gambar, analisis gambar tersebut dan jawab soal atau pertanyaan yang ada di dalamnya dengan struktur Markdown yang rapi, seperti teks tebal untuk penekanan, daftar untuk poin-poin, dan paragraf untuk penjelasan. Hindari jargon teknis yang rumit kecuali diminta, dan pastikan respons mudah dipahami.`;

        // Auto-focus input on load
        userInput.focus();

        // Send message on button click or Enter key
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Handle image upload
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64Image = event.target.result.split(',')[1]; // Get base64 data
                    addMessage('user', userInput.value || 'Gambar diunggah', base64Image);
                    sendMessageWithImage(base64Image);
                    imageInput.value = ''; // Clear input
                };
                reader.readAsDataURL(file);
            }
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Display user message
            addMessage('user', message);
            userInput.value = '';

            // Show loading indicator
            const loadingDiv = addMessage('ai', 'Memproses...');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                { text: message }
                            ]
                        }]
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    // Replace loading with AI response
                    loadingDiv.innerHTML = formatMessage('AI', aiResponse);
                } else {
                    throw new Error(data.error?.message || 'Error fetching response');
                }
            } catch (error) {
                loadingDiv.innerHTML = formatMessage('AI', `**Error:** ${error.message}`);
                alert(`Gagal mengirim pesan: ${error.message}. Periksa API key atau aktifkan Generative Language API di Google Cloud Console.`);
            }
        }

        async function sendMessageWithImage(base64Image) {
            const message = userInput.value.trim() || 'Analisis gambar dan jawab soal yang ada di dalamnya.';
            userInput.value = '';

            // Show loading indicator
            const loadingDiv = addMessage('ai', 'Memproses gambar...');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                { text: message },
                                {
                                    inlineData: {
                                        mimeType: 'image/jpeg', // Adjust based on image type
                                        data: base64Image
                                    }
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    // Replace loading with AI response
                    loadingDiv.innerHTML = formatMessage('AI', aiResponse);
                } else {
                    throw new Error(data.error?.message || 'Error fetching response');
                }
            } catch (error) {
                loadingDiv.innerHTML = formatMessage('AI', `**Error:** ${error.message}`);
                alert(`Gagal mengirim pesan: ${error.message}. Periksa API key atau aktifkan Generative Language API di Google Cloud Console.`);
            }
        }

        function addMessage(sender, text, imageBase64 = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message p-3 rounded-lg ${sender === 'user' ? 'bg-cyan-500 text-gray-900 ml-auto' : 'bg-gray-700 text-cyan-300'} max-w-[80%]`;
            let content = formatMessage(sender === 'user' ? 'Anda' : 'AI', text);
            if (imageBase64) {
                content += `<br><img src="data:image/jpeg;base64,${imageBase64}" class="image-preview" alt="Uploaded image">`;
            }
            messageDiv.innerHTML = content;
            chatBox.appendChild(messageDiv);
            // Auto-scroll to the latest message
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            chatBox.scrollTop = chatBox.scrollHeight; // Fallback for compatibility
            return messageDiv;
        }

        function formatMessage(sender, text) {
            // Render Markdown using Marked.js
            const renderedText = marked.parse(text, {
                breaks: true, // Treat single newlines as <br>
                gfm: true // Enable GitHub Flavored Markdown
            });
            return `<strong>${sender}:</strong> <div class="markdown-content">${renderedText}</div>`;
        }
    </script>
</body>
</html>
